{"version":3,"file":"13.Bm07QGss.js","sources":["../../../../../../src/routes/subscription/+page.ts","../../../../../../../subscription/out/index.js","../../../../../../src/routes/subscription/+page.svelte"],"sourcesContent":["export const prerender = true;","import template from './template.v3.json' with { type: \"json\" };\nimport packageInfo from '../package.json' with { type: \"json\" };\nimport { binToHex, createVirtualMachineBch, encodeTransactionBch, generateTransaction, hexToBin, verifyTransactionTokens } from '@bitauth/libauth';\nimport { getAddress, getLibauthCompiler, getScriptHash, numToVm, } from '@unspent/tau';\nexport default class Subscription {\n    static USER_AGENT = packageInfo.name;\n    static PROTOCOL_IDENTIFIER = \"U3S\";\n    static tokenAware = true;\n    static template = template;\n    static compiler = getLibauthCompiler(this.template);\n    static vm = createVirtualMachineBch();\n    static dataToBytecode(data) {\n        return {\n            \"installment\": numToVm(data.installment),\n            \"recipient\": hexToBin(data.recipient),\n            \"period\": numToVm(data.period),\n            \"auth\": hexToBin(data.auth),\n        };\n    }\n    static getLockingBytecode(data) {\n        const lockingBytecodeResult = this.compiler.generateBytecode({\n            data: {\n                \"bytecode\": this.dataToBytecode(data)\n            },\n            scriptId: 'lock'\n        });\n        if (!lockingBytecodeResult.success)\n            throw new Error('Failed to generate bytecode, script: , ' + JSON.stringify(lockingBytecodeResult, null, '  '));\n        return lockingBytecodeResult.bytecode;\n    }\n    static getUnlockingBytecode(data) {\n        const bytecodeResult = this.compiler.generateBytecode({\n            data: {\n                \"bytecode\": this.dataToBytecode(data)\n            },\n            scriptId: 'step'\n        });\n        if (!bytecodeResult.success)\n            throw new Error('Failed to generate bytecode, script: , ' + JSON.stringify(bytecodeResult, null, '  '));\n        return bytecodeResult.bytecode;\n    }\n    /**\n     * Get cashaddress\n     *\n     * @param data - the parameters of the subscription.\n     * @param reversed - whether to reverse the hash.\n     * @throws {Error} if transaction generation fails.\n     * @returns a cashaddress.\n     */\n    static getScriptHash(data, reversed = true) {\n        return getScriptHash(this.getLockingBytecode(data), reversed);\n    }\n    /**\n     * Get cashaddress\n     *\n     * @param data - the parameters of the subscription.\n     * @param prefix - cashaddress prefix.\n     * @throws {Error} if transaction generation fails.\n     * @returns a cashaddress.\n     */\n    static getAddress(data, prefix = \"bitcoincash\") {\n        return getAddress(this.getLockingBytecode(data), prefix, this.tokenAware);\n    }\n    static getSourceOutput(data, utxo) {\n        return {\n            lockingBytecode: this.getLockingBytecode(data),\n            valueSatoshis: BigInt(utxo.value)\n        };\n    }\n    static getInput(data, utxo) {\n        return {\n            outpointIndex: utxo.tx_pos,\n            outpointTransactionHash: hexToBin(utxo.tx_hash),\n            sequenceNumber: utxo.value,\n            unlockingBytecode: {\n                data: {\n                    \"bytecode\": this.dataToBytecode(data)\n                },\n                compiler: this.compiler,\n                script: 'unlock',\n                valueSatoshis: BigInt(utxo.value),\n            },\n        };\n    }\n    static getOutput() {\n        return {\n            lockingBytecode: {\n                data: {\n                // \"bytecode\": {\n                //     \"key\": hexToBin(indexKey)\n                // }\n                },\n                compiler: this.compiler,\n                script: 'op_return'\n            },\n            valueSatoshis: BigInt(0)\n        };\n    }\n    /**\n     * Get source outputs, transform contract & wallet outpoints for spending verification.\n     *\n     * @param data - the parameters of the subscription.\n     * @param valueUtxos - wallet outputs to use as input.\n     * @param key - private key to sign transaction wallet inputs.\n     *\n     * @returns a transaction template.\n     */\n    static getSourceOutputs(data, valueUtxos) {\n        const sourceOutputs = [];\n        sourceOutputs.push(...valueUtxos.map((u) => this.getSourceOutput(data, u)));\n        return sourceOutputs;\n    }\n    /**\n     * Step expired records.\n     *\n     * @param data - The parameters of the subscription\n     * @param utxo - The output paying the installment\n     *\n     * @throws {Error} if transaction generation fails.\n     * @returns a transaction template.\n     */\n    static step(data, utxo) {\n        const inputs = [];\n        const outputs = [];\n        let config = {\n            locktime: 0,\n            version: 2,\n            inputs,\n            outputs\n        };\n        config.inputs.push(this.getInput(data, utxo));\n        config.outputs.push(this.getOutput());\n        let result = generateTransaction(config);\n        if (!result.success)\n            throw new Error('generate transaction failed!, errors: ' + JSON.stringify(result.errors, null, '  '));\n        const sourceOutputs = [this.getSourceOutput(data, utxo)];\n        const transaction = result.transaction;\n        const tokenValidationResult = verifyTransactionTokens(transaction, sourceOutputs, { maximumTokenCommitmentLength: 40 });\n        if (tokenValidationResult !== true)\n            throw tokenValidationResult;\n        let verify = this.vm.verify({\n            sourceOutputs: sourceOutputs,\n            transaction: transaction,\n        });\n        if (typeof verify == \"string\")\n            throw verify;\n        return binToHex(encodeTransactionBch(transaction));\n    }\n}\n//# sourceMappingURL=index.js.map","<script lang=\"ts\">\n\timport Readme from './README.md';\n\n\timport BitauthLink from '$lib/BitauthLink.svelte';\n\timport CONNECTED from '$lib/images/connected.svg';\n\timport DISCONNECTED from '$lib/images/disconnected.svg';\n\n\timport Subscription from '@unspent/subscription';\n\n\tlet connectionStatus = $state('');\n</script>\n\n<section>\n\t<div class=\"status\">\n\t\t<BitauthLink template={Subscription.template} />\n\t\t{#if connectionStatus == 'CONNECTED'}\n\t\t\t<img src={CONNECTED} alt={connectionStatus} />\n\t\t{:else}\n\t\t\t<img src={DISCONNECTED} alt=\"Disconnected\" />\n\t\t{/if}\n\t</div>\n\n\t<Readme />\n</section>\n\n<style>\n\t.status {\n\t\ttext-align: end;\n\t}\n</style>\n"],"names":["prerender","Subscription","packageInfo","template","getLibauthCompiler","createVirtualMachineBch","data","numToVm","hexToBin","lockingBytecodeResult","bytecodeResult","reversed","getScriptHash","prefix","getAddress","utxo","valueUtxos","sourceOutputs","u","config","result","generateTransaction","transaction","tokenValidationResult","verifyTransactionTokens","verify","binToHex","encodeTransactionBch","DISCONNECTED","$$render","alternate"],"mappings":"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"}
{"version":3,"file":"10.BSI6_Jzn.js","sources":["../../../../../../src/routes/future/+page.ts","../../../../../../src/routes/future/+page.svelte"],"sourcesContent":["export const prerender =true;","<script lang=\"ts\">\n\timport { onMount } from 'svelte';\n\timport { page } from '$app/state';\n\n\timport Loading from '$lib/Loading.svelte';\n\n\t// @ts-ignore\n\timport Readme from './README.md';\n\n\timport BitauthLink from '$lib/BitauthLink.svelte';\n\timport CONNECTED from '$lib/images/connected.svg';\n\timport DISCONNECTED from '$lib/images/disconnected.svg';\n\timport FutureCoupon from '$lib/FutureCoupon.svelte';\n\n\timport {\n\t\tbinToHex,\n\t\tcashAddressToLockingBytecode,\n\t\tencodeTransactionBch,\n\t\tstringify\n\t} from '@bitauth/libauth';\n\n\timport { ElectrumClient, ConnectionStatus } from '@electrum-cash/network';\n\timport { BaseWallet, Wallet, TestNetWallet } from 'mainnet-js';\n\n\timport { IndexedDBProvider } from '@mainnet-cash/indexeddb-storage';\n\n\timport { getScriptHash, getHdPrivateKey, sumUtxoValue, type UtxoI, sleep } from '@unspent/tau';\n\timport { Vault, USER_AGENT, type CouponItemI } from '@fbch/lib';\n\timport { TIMELOCK_MAP, TIMELOCK_MAP_CHIPNET } from '@fbch/lib';\n\n\timport BCH from '$lib/images/BCH.svg';\n\timport tBCH from '$lib/images/tBCH.svg';\n\n\tlet now: number = $state(0);\n\n\tlet key = $state('');\n\tlet coupons: any[] | undefined = $state.raw();\n\tlet electrumClient: any;\n\tlet timer: any;\n\tlet couponGrouped: Map<string, CouponItemI[]> | undefined = $state();\n\tlet walletScriptHash = $state('');\n\tlet amount = $state(0);\n\tlet openCouponInterest = $state(0);\n\tlet couponTotal = $state(0);\n\tlet connectionStatus = $state('');\n\tlet contractState = $state('');\n\n\tlet walletUnspent: any[] = $state.raw([]);\n\tlet broadcastQueue: string[] = $state([]);\n\tlet vaultCache: Map<number, UtxoI[]> = new Map([]);\n\tlet walletBalance = $state(0);\n\n\tconst isMainnet = page.url.hostname == 'vox.cash';\n\tconst ticker = isMainnet ? 'BCH' : 'tBCH';\n\tconst baseTicker = isMainnet ? 'FBCH' : 'tFBCH';\n\tconst prefix = isMainnet ? 'bitcoincash' : 'bchtest';\n\tconst server = isMainnet ? 'bch.imaginary.cash' : 'chipnet.bch.ninja';\n\tconst SERIES_MAP = isMainnet ? TIMELOCK_MAP : TIMELOCK_MAP_CHIPNET;\n\tconst bchIcon = isMainnet ? BCH : tBCH;\n\n\tlet wallet: any;\n\tlet disableUi = false;\n\n\t\n\tconst debounceUpdateWallet = () => {\n\t\tclearTimeout(timer);\n\t\ttimer = setTimeout(() => {\n\t\t\tupdateWallet();\n\t\t\tupdateCoupons();\n\t\t}, 5000);\n\t};\n\n\tconst debounceBroadcastQue = async () => {\n\t\tclearTimeout(timer);\n\t\ttimer = setTimeout(async () => {\n\t\t\twhile (broadcastQueue.length) {\n\t\t\t\tlet tx = broadcastQueue.shift()!;\n\t\t\t\ttry {\n\t\t\t\t\tawait broadcast(tx);\n\t\t\t\t\tawait sleep(400);\n\t\t\t\t\tconsole.log('broadcast');\n\t\t\t\t} catch (e) {\n\t\t\t\t\t// if one transaction failed, the whole chain is borked,\n\t\t\t\t\t// start over.\n\t\t\t\t\tconsole.error(e);\n\t\t\t\t\tbroadcastQueue = [];\n\t\t\t\t\twalletUnspent = [];\n\t\t\t\t\tvaultCache = new Map([]);\n\t\t\t\t\tdebounceUpdateWallet();\n\t\t\t\t}\n\t\t\t}\n\t\t}, 500);\n\t};\n\n\tasync function handlePlacement(coupon: any) {\n\t\tif (!vaultCache.has(coupon.locktime)) {\n\t\t\tvaultCache.set(\n\t\t\t\tcoupon.locktime,\n\t\t\t\tawait electrumClient.request(\n\t\t\t\t\t'blockchain.scripthash.listunspent',\n\t\t\t\t\tVault.getScriptHash(coupon.locktime),\n\t\t\t\t\t'include_tokens'\n\t\t\t\t)\n\t\t\t);\n\t\t}\n\n\t\t// filter out junk Utxos in vault.\n\t\tlet vaultUtxos = vaultCache\n\t\t\t.get(coupon.locktime)!\n\t\t\t.filter((u) => u.token_data?.category == SERIES_MAP.get(coupon.locktime));\n\n\t\tlet swapTx = Vault.swap(\n\t\t\tcoupon.placement,\n\t\t\tvaultUtxos,\n\t\t\twalletUnspent,\n\t\t\tcoupon.locktime,\n\t\t\tkey,\n\t\t\tcoupon\n\t\t);\n\n\t\tlet transactionHex = binToHex(encodeTransactionBch(swapTx.transaction));\n\t\tbroadcastQueue.push(transactionHex);\n\t\tdebounceBroadcastQue();\n\n\t\tcoupons = coupons?.filter((c) => !(c.tx_hash == coupon.tx_hash && c.tx_pos == coupon.tx_pos));\n\t\tcouponGrouped = Map.groupBy(\n\t\t\tcoupons!,\n\t\t\t({ locktime, placement, value }) => `${locktime}-${placement}-${value}`\n\t\t);\n\t\twalletUnspent = swapTx.walletUtxos;\n\t\tvaultCache.set(coupon.locktime, swapTx.contractUtxos);\n\t\twalletBalance -= coupon.placement\n\t}\n\n\tconst broadcast = async function (raw_tx: string) {\n\t\tlet response = await electrumClient.request('blockchain.transaction.broadcast', raw_tx);\n\t\tif (response instanceof Error) {\n\t\t\tconnectionStatus = ConnectionStatus[electrumClient.status];\n\t\t\tthrow response;\n\t\t}\n\t\tresponse as any[];\n\t};\n\n\tasync function updateCoupons() {\n\t\tif (electrumClient && now > 1000) {\n\t\t\tcoupons = await Vault.getAllCouponUtxos(electrumClient, now);\n\t\t}\n\t\tif (coupons) {\n\t\t\tcouponGrouped = Map.groupBy(\n\t\t\t\tcoupons,\n\t\t\t\t({ locktime, placement, value }) => `${locktime}-${placement}-${value}`\n\t\t\t);\n\n\t\t\tcoupons.sort((a: any, b: any) => parseFloat(b.spb) - parseFloat(a.spb));\n\t\t\topenCouponInterest = Number(coupons.reduce((acc, c) => acc + c.placement, 0) / 1e8);\n\t\t\tcouponTotal = Number(coupons.reduce((acc, c) => acc + c.value, 0));\n\t\t}\n\t}\n\n\tconst updateWallet = async function () {\n\t\tlet response = await electrumClient.request(\n\t\t\t'blockchain.scripthash.listunspent',\n\t\t\twalletScriptHash,\n\t\t\t'include_tokens'\n\t\t);\n\t\tif (response instanceof Error) throw response;\n\n\t\twalletUnspent = response.filter((u: UtxoI) => !u.token_data?.nft);\n\t\twalletBalance = sumUtxoValue(walletUnspent, true);\n\t};\n\n\tconst handleNotifications = function (data: any) {\n\t\tconnectionStatus = ConnectionStatus[electrumClient.status];\n\t\tif (data.method === 'blockchain.headers.subscribe') {\n\t\t\tlet d = data.params[0];\n\t\t\tnow = d.height;\n\t\t\tdebounceUpdateWallet();\n\t\t} else if (data.method === 'blockchain.scripthash.subscribe') {\n\t\t\tif (data.params[1] !== contractState) {\n\t\t\t\tcontractState = data.params[1];\n\t\t\t\tamount = 0;\n\t\t\t\tdebounceUpdateWallet();\n\t\t\t}\n\t\t} else {\n\t\t\tconsole.log(data);\n\t\t}\n\t};\n\n\tonMount(async () => {\n\t\tBaseWallet.StorageProvider = IndexedDBProvider;\n\t\twallet = isMainnet ? await Wallet.named(`vox`) : await TestNetWallet.named(`vox`);\n\n\t\tkey = getHdPrivateKey(wallet.mnemonic!, wallet.derivationPath.slice(0, -2), wallet.isTestnet);\n\t\tlet lockingBytecodeResult = cashAddressToLockingBytecode(wallet.getDepositAddress());\n\t\tif (typeof lockingBytecodeResult == 'string') throw lockingBytecodeResult;\n\t\twalletScriptHash = getScriptHash(lockingBytecodeResult.bytecode);\n\n\t\t// Initialize an electrum client.\n\t\telectrumClient = new ElectrumClient(USER_AGENT, '1.4.1', server);\n\n\t\t// Wait for the client to connect.\n\t\tawait electrumClient.connect();\n\t\t// Set up a callback function to handle new blocks.\n\n\t\t// Listen for notifications.\n\t\telectrumClient.on('notification', handleNotifications);\n\n\t\t// Set up a subscription for new block headers.\n\t\tawait electrumClient.subscribe('blockchain.headers.subscribe');\n\t\tawait electrumClient.subscribe('blockchain.scripthash.subscribe', walletScriptHash);\n\t\tupdateWallet();\n\t\tupdateCoupons();\n\t});\n</script>\n\n<svelte:head>\n\t<title>ðŸ…µâ€‹ BCH</title>\n\t<meta name=\"description\" content=\"Swap coins for Futures.\" />\n</svelte:head>\n\n<section>\n\t<div class=\"status\">\n\t\t{now.toLocaleString()}\n\t\t<BitauthLink template={Vault.template} />\n\t\t{#if connectionStatus == 'CONNECTED'}\n\t\t\t<img src={CONNECTED} alt={connectionStatus} />\n\t\t{:else}\n\t\t\t<img src={DISCONNECTED} alt=\"Disconnected\" />\n\t\t{/if}\n\t</div>\n\n\t<h1>Stake coins for futures</h1>\n\n\t<div class=\"swap\">\n\t\t<div>\n\t\t\t{Number(walletBalance / 100_000_000).toLocaleString(undefined, { maximumFractionDigits: 1 })}\n\t\t\t{ticker} <img width=\"20\" src={bchIcon} alt={ticker} />\n\t\t</div>\n\t</div>\n\n\t{#if couponGrouped}\n\t\t{#if couponGrouped.size > 0}\n\t\t\t{#each couponGrouped.values() as subList}\n\t\t\t\t{#each subList as c, i}\n\t\t\t\t\t{#if i == 0}\n\t\t\t\t\t\t<FutureCoupon\n\t\t\t\t\t\t\t{handlePlacement}\n\t\t\t\t\t\t\t{...c}\n\t\t\t\t\t\t\t{isMainnet}\n\t\t\t\t\t\t\tcouponCount={subList.length}\n\t\t\t\t\t\t\tbalance={walletBalance}\n\t\t\t\t\t\t/>\n\t\t\t\t\t{/if}\n\t\t\t\t{/each}\n\t\t\t{/each}\n\t\t{:else}\n\t\t\t<p>no coupons available</p>\n\t\t{/if}\n\t{:else}\n\t\t<div style=\"text-align:center\">\n\t\t\t<h2>loading coupons</h2>\n\t\t\t<Loading />\n\t\t</div>\n\t{/if}\n\t<div>\n\t\t<p style=\"font-size:small\">\n\t\t\t<i>sats (satoshis)</i>: one 100,000,000<sup>th</sup> of a whole coin.<br />\n\t\t\t<i>spb</i>: rate in sats per coin per block of time remaining to maturation.<br />\n\t\t\t<i>apy, coupon rate per annum</i>: effective non-compounding rate of annual return. Note:\n\t\t\tapproximate rates assume 870 sats network transaction fees (550 swap, 320 redeem)â€•paid to\n\t\t\tminers.\n\t\t</p>\n\t</div>\n\t<Readme />\n</section>\n\n<style>\n\t.status {\n\t\ttext-align: end;\n\t\tcolor: #ffffff;\n\t\tfont-weight: 600;\n\t}\n\n\t.swap {\n\t\tdisplay: flex;\n\t\tmargin: auto;\n\t\talign-items: center;\n\t\tjustify-content: center;\n\t}\n\t.swap div {\n\t\tfont-size: x-large;\n\t}\n</style>\n"],"names":["prerender","now","key","coupons","$.state","electrumClient","timer","couponGrouped","walletScriptHash","amount","openCouponInterest","couponTotal","connectionStatus","contractState","walletUnspent","broadcastQueue","$.proxy","vaultCache","walletBalance","isMainnet","page","ticker","server","SERIES_MAP","TIMELOCK_MAP","TIMELOCK_MAP_CHIPNET","bchIcon","BCH","tBCH","wallet","debounceUpdateWallet","updateWallet","updateCoupons","debounceBroadcastQue","tx","$.get","broadcast","sleep","e","handlePlacement","coupon","Vault","vaultUtxos","u","swapTx","transactionHex","binToHex","encodeTransactionBch","c","$.set","locktime","placement","value","raw_tx","response","ConnectionStatus","a","b","acc","sumUtxoValue","handleNotifications","data","d","onMount","BaseWallet","IndexedDBProvider","Wallet","TestNetWallet","getHdPrivateKey","lockingBytecodeResult","cashAddressToLockingBytecode","getScriptHash","ElectrumClient","USER_AGENT","CONNECTED","DISCONNECTED","$$render","consequent","alternate","$.index","$$anchor","subList","$.each","node_5","i","consequent_1","consequent_2","alternate_1","consequent_3","alternate_2"],"mappings":"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"}
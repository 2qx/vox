{"version":3,"file":"15.DGtZ43x5.js","sources":["../../../../../../src/routes/timeout/+page.ts","../../../../../../../timeout/out/index.js","../../../../../../src/routes/timeout/+page.svelte"],"sourcesContent":["export const prerender = true;","import template from './template.v3.json' with { type: \"json\" };\nimport packageInfo from '../package.json' with { type: \"json\" };\nimport { binToHex, createVirtualMachineBch, encodeDataPush, encodeTransactionBch, generateTransaction, hexToBin, verifyTransactionTokens } from '@bitauth/libauth';\nimport { getAddress, getLibauthCompiler, getScriptHash, numToVm, } from '@unspent/tau';\nexport default class Timeout {\n    static USER_AGENT = packageInfo.name;\n    static tokenAware = true;\n    static template = template;\n    static compiler = getLibauthCompiler(this.template);\n    static vm = createVirtualMachineBch();\n    static dataToBytecode(data) {\n        return {\n            \"recipient\": hexToBin(data.recipient),\n            \"timeout\": numToVm(data.timeout),\n            \"auth\": hexToBin(data.auth)\n        };\n    }\n    static dataToCommitmentRecord(data) {\n        const byteData = this.dataToBytecode(data);\n        return Uint8Array.from([\n            ...encodeDataPush(byteData.recipient),\n            ...encodeDataPush(byteData.timeout)\n        ]);\n    }\n    static getLockingBytecode(data) {\n        const lockingBytecodeResult = this.compiler.generateBytecode({\n            data: {\n                \"bytecode\": this.dataToBytecode(data)\n            },\n            scriptId: 'lock'\n        });\n        if (!lockingBytecodeResult.success)\n            throw new Error('Failed to generate bytecode, script: , ' + JSON.stringify(lockingBytecodeResult, null, '  '));\n        return lockingBytecodeResult.bytecode;\n    }\n    static getUnlockingBytecode(data) {\n        const bytecodeResult = this.compiler.generateBytecode({\n            data: {\n                \"bytecode\": this.dataToBytecode(data)\n            },\n            scriptId: 'unlock'\n        });\n        if (!bytecodeResult.success)\n            throw new Error('Failed to generate bytecode, script: , ' + JSON.stringify(bytecodeResult, null, '  '));\n        return bytecodeResult.bytecode;\n    }\n    /**\n     * Get cashaddress\n     *\n     * @param data - the timeout parameters.\n     * @param reversed - whether to reverse the hash.\n     * @throws {Error} if transaction generation fails.\n     * @returns a cashaddress.\n     */\n    static getScriptHash(data, reversed = true) {\n        return getScriptHash(this.getLockingBytecode(data), reversed);\n    }\n    /**\n     * Get cashaddress\n     *\n     * @param data - the timeout parameters.\n     * @param prefix - cashaddress prefix.\n     * @throws {Error} if transaction generation fails.\n     * @returns a cashaddress.\n     */\n    static getAddress(data, prefix = \"bitcoincash\") {\n        return getAddress(this.getLockingBytecode(data), prefix, this.tokenAware);\n    }\n    static getSourceOutput(data, utxo) {\n        return {\n            lockingBytecode: this.getLockingBytecode(data),\n            valueSatoshis: BigInt(utxo.value)\n        };\n    }\n    static getInput(data, utxo) {\n        return {\n            outpointIndex: utxo.tx_pos,\n            outpointTransactionHash: hexToBin(utxo.tx_hash),\n            sequenceNumber: utxo.value,\n            unlockingBytecode: {\n                data: {\n                    \"bytecode\": this.dataToBytecode(data)\n                },\n                compiler: this.compiler,\n                script: 'unlock',\n                valueSatoshis: BigInt(utxo.value),\n            },\n        };\n    }\n    static getOutput() {\n        return {\n            lockingBytecode: {\n                data: {\n                // \"bytecode\": {\n                //     \"key\": hexToBin(indexKey)\n                // }\n                },\n                compiler: this.compiler,\n                script: 'op_return'\n            },\n            valueSatoshis: BigInt(0)\n        };\n    }\n    /**\n     * Get source outputs, transform contract & wallet outpoints for spending verification.\n     *\n     * @param contractUtxo - contract outputs to use as input.\n     * @param walletUtxo - wallet outputs to use as input.\n     * @param key - private key to sign transaction wallet inputs.\n     *\n     * @returns a transaction template.\n     */\n    static getSourceOutputs(data, valueUtxos) {\n        const sourceOutputs = [];\n        sourceOutputs.push(...valueUtxos.map((u) => this.getSourceOutput(data, u)));\n        return sourceOutputs;\n    }\n    /**\n     * Liquidate the contact upon timeout.\n     *\n     * @param data - The\n     * @param utxo - contract record to pay out.\n     *\n     * @throws {Error} if transaction generation fails.\n     * @returns a transaction template.\n     */\n    static liquidate(data, utxo) {\n        const inputs = [];\n        const outputs = [];\n        let config = {\n            locktime: 0,\n            version: 2,\n            inputs,\n            outputs\n        };\n        config.inputs.push(this.getInput(data, utxo));\n        config.outputs.push(this.getOutput());\n        let result = generateTransaction(config);\n        if (!result.success)\n            throw new Error('generate transaction failed!, errors: ' + JSON.stringify(result.errors, null, '  '));\n        const sourceOutputs = [this.getSourceOutput(data, utxo)];\n        const transaction = result.transaction;\n        const tokenValidationResult = verifyTransactionTokens(transaction, sourceOutputs, { maximumTokenCommitmentLength: 40 });\n        if (tokenValidationResult !== true)\n            throw tokenValidationResult;\n        let verify = this.vm.verify({\n            sourceOutputs: sourceOutputs,\n            transaction: transaction,\n        });\n        if (typeof verify == \"string\")\n            throw verify;\n        return binToHex(encodeTransactionBch(transaction));\n    }\n}\n//# sourceMappingURL=index.js.map","<script lang=\"ts\">\n\timport Readme from './README.md';\n\n\timport BitauthLink from '$lib/BitauthLink.svelte';\n\timport CONNECTED from '$lib/images/connected.svg';\n\timport DISCONNECTED from '$lib/images/disconnected.svg';\n\n\timport Timeout from '@unspent/timeout';\n\n\tlet connectionStatus = $state('');\n</script>\n\n<section>\n\t<div class=\"status\">\n\t\t<BitauthLink template={Timeout.template} />\n\t\t{#if connectionStatus == 'CONNECTED'}\n\t\t\t<img src={CONNECTED} alt={connectionStatus} />\n\t\t{:else}\n\t\t\t<img src={DISCONNECTED} alt=\"Disconnected\" />\n\t\t{/if}\n\t</div>\n\n\t<Readme />\n</section>\n\n<style>\n\t.status {\n\t\ttext-align: end;\n\t}\n</style>\n"],"names":["prerender","Timeout","packageInfo","template","getLibauthCompiler","createVirtualMachineBch","data","hexToBin","numToVm","byteData","encodeDataPush","lockingBytecodeResult","bytecodeResult","reversed","getScriptHash","prefix","getAddress","utxo","valueUtxos","sourceOutputs","u","config","result","generateTransaction","transaction","tokenValidationResult","verifyTransactionTokens","verify","binToHex","encodeTransactionBch","DISCONNECTED","$$render","alternate"],"mappings":"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"}
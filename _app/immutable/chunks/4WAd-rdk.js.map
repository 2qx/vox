{"version":3,"file":"4WAd-rdk.js","sources":["../../../../../../../../node_modules/.pnpm/@bitauth+libauth@3.1.0-next.8/node_modules/@bitauth/libauth/build/lib/transaction/generate-transaction.js"],"sourcesContent":["import { allErrorsAreRecoverable, extractResolvedVariableBytecodeMap, } from '../language/language.js';\nconst returnFailedCompilationDirective = ({ index, result, type, }) => ({\n    errors: result.errors.map((error) => ({\n        ...error,\n        error: `Failed compilation of ${type} directive at index \"${index}\": ${error.error}`,\n    })),\n    index,\n    ...(result.errorType === 'parse' ? {} : { resolved: result.resolve }),\n    type,\n});\n// eslint-disable-next-line complexity\nexport const compileOutputTemplate = ({ outputTemplate, index, }) => {\n    if ('script' in outputTemplate.lockingBytecode) {\n        const directive = outputTemplate.lockingBytecode;\n        const data = directive.data ?? {};\n        const result = directive.compiler.generateBytecode({\n            data,\n            debug: true,\n            scriptId: directive.script,\n        });\n        return result.success\n            ? {\n                lockingBytecode: result.bytecode,\n                ...(outputTemplate.token === undefined\n                    ? {}\n                    : { token: outputTemplate.token }),\n                valueSatoshis: outputTemplate.valueSatoshis,\n            }\n            : returnFailedCompilationDirective({ index, result, type: 'locking' });\n    }\n    return {\n        lockingBytecode: outputTemplate.lockingBytecode.slice(),\n        ...(outputTemplate.token === undefined\n            ? {}\n            : { token: outputTemplate.token }),\n        valueSatoshis: outputTemplate.valueSatoshis,\n    };\n};\nexport const compileInputTemplate = ({ inputTemplate, index, template, outputs, }) => {\n    if ('script' in inputTemplate.unlockingBytecode) {\n        const directive = inputTemplate.unlockingBytecode;\n        // TODO: workaround, replace by migrating to PST format\n        const sourceOutputs = [];\n        // eslint-disable-next-line functional/no-expression-statements, functional/immutable-data\n        sourceOutputs[index] = {\n            lockingBytecode: Uint8Array.of(),\n            ...(inputTemplate.unlockingBytecode.token === undefined\n                ? {}\n                : { token: inputTemplate.unlockingBytecode.token }),\n            valueSatoshis: inputTemplate.unlockingBytecode.valueSatoshis,\n        };\n        const result = directive.compiler.generateBytecode({\n            data: {\n                ...directive.data,\n                compilationContext: {\n                    inputIndex: index,\n                    sourceOutputs,\n                    transaction: {\n                        inputs: template.inputs,\n                        locktime: template.locktime,\n                        outputs,\n                        version: template.version,\n                    },\n                },\n            },\n            debug: true,\n            scriptId: directive.script,\n        });\n        return result.success\n            ? {\n                outpointIndex: inputTemplate.outpointIndex,\n                outpointTransactionHash: inputTemplate.outpointTransactionHash.slice(),\n                sequenceNumber: inputTemplate.sequenceNumber,\n                unlockingBytecode: result.bytecode,\n            }\n            : returnFailedCompilationDirective({ index, result, type: 'unlocking' });\n    }\n    return {\n        outpointIndex: inputTemplate.outpointIndex,\n        outpointTransactionHash: inputTemplate.outpointTransactionHash.slice(),\n        sequenceNumber: inputTemplate.sequenceNumber,\n        unlockingBytecode: inputTemplate.unlockingBytecode.slice(),\n    };\n};\n/**\n * Generate a `Transaction` given a `TransactionTemplate` and any applicable\n * compilers and compilation data.\n *\n * Returns either a `Transaction` or an array of compilation errors.\n *\n * For each `CompilationDirective`, the `compilationContext` property will be\n * automatically provided to the compiler. All other necessary `CompilationData`\n * properties must be specified in the `TransactionTemplate`.\n *\n * @param template - the `TransactionTemplate` from which to create the\n * `Transaction`\n */\nexport const generateTransaction = (template) => {\n    const outputResults = template.outputs.map((outputTemplate, index) => compileOutputTemplate({\n        index,\n        outputTemplate,\n    }));\n    const outputCompilationErrors = outputResults.filter((result) => 'errors' in result);\n    if (outputCompilationErrors.length > 0) {\n        const outputCompletions = outputResults\n            .map((result, index) => 'lockingBytecode' in result\n            ? { index, output: result, type: 'output' }\n            : result)\n            .filter((result) => 'output' in result);\n        return {\n            completions: outputCompletions,\n            errors: outputCompilationErrors,\n            stage: 'outputs',\n            success: false,\n        };\n    }\n    const outputs = outputResults;\n    const inputResults = template.inputs.map((inputTemplate, index) => compileInputTemplate({\n        index,\n        inputTemplate,\n        outputs,\n        template,\n    }));\n    const inputCompilationErrors = inputResults.filter((result) => 'errors' in result);\n    if (inputCompilationErrors.length > 0) {\n        const inputCompletions = inputResults\n            .map((result, index) => 'unlockingBytecode' in result\n            ? { index, input: result, type: 'input' }\n            : result)\n            .filter((result) => 'input' in result);\n        return {\n            completions: inputCompletions,\n            errors: inputCompilationErrors,\n            stage: 'inputs',\n            success: false,\n        };\n    }\n    const inputs = inputResults;\n    return {\n        success: true,\n        transaction: {\n            inputs,\n            locktime: template.locktime,\n            outputs,\n            version: template.version,\n        },\n    };\n};\n/**\n * TODO: fundamentally unsound, migrate to PST format\n *\n * Extract a map of successfully resolved variables to their resolved bytecode.\n *\n * @param transactionGenerationError - a transaction generation attempt where\n * `success` is `false`\n */\nexport const extractResolvedVariables = (transactionGenerationError) => transactionGenerationError.errors.reduce((all, error) => error.resolved === undefined\n    ? all\n    : { ...all, ...extractResolvedVariableBytecodeMap(error.resolved) }, {});\n/**\n * TODO: fundamentally unsound, migrate to PST format\n *\n * Given an unsuccessful transaction generation result, extract a map of the\n * identifiers missing from the compilation mapped to the entity that owns each\n * variable.\n *\n * Returns `false` if any errors are fatal (the error either cannot be resolved\n * by providing a variable, or the entity ownership of the required variable was\n * not provided in the compilation data).\n *\n * @param transactionGenerationError - a transaction generation result where\n * `success` is `false`\n */\nexport const extractMissingVariables = (transactionGenerationError) => {\n    const allErrors = transactionGenerationError.errors.reduce((all, error) => [...all, ...error.errors], []);\n    if (!allErrorsAreRecoverable(allErrors)) {\n        return false;\n    }\n    return allErrors.reduce((all, error) => ({\n        ...all,\n        [error.missingIdentifier]: error.owningEntity,\n    }), {});\n};\n/**\n * TODO: fundamentally unsound, migrate to PST format\n *\n * Safely extend a compilation data with resolutions provided by other entities\n * (via `extractResolvedVariables`).\n *\n * It is security-critical that compilation data only be extended with expected\n * identifiers from the proper owning entity of each variable. See\n * `CompilationData.bytecode` for details.\n *\n * Returns `false` if any errors are fatal (the error either cannot be resolved\n * by providing a variable, or the entity ownership of the required variable was\n * not provided in the compilation data).\n *\n * @remarks\n * To determine which identifiers are required by a given compilation, the\n * compilation is first attempted with only trusted variables: variables owned\n * or previously verified (like `WalletData`) by the compiling entity. If this\n * compilation produces a `TransactionGenerationError`, the error can be\n * provided to `safelyExtendCompilationData`, along with the trusted compilation\n * data and a mapping of untrusted resolutions (where the result of\n * `extractResolvedVariables` is assigned to the entity ID of the entity from\n * which they were received).\n *\n * The first compilation must use only trusted compilation data\n */\nexport const safelyExtendCompilationData = (transactionGenerationError, trustedCompilationData, untrustedResolutions) => {\n    const missing = extractMissingVariables(transactionGenerationError);\n    if (missing === false)\n        return false;\n    const selectedResolutions = Object.entries(missing).reduce((all, [identifier, entityId]) => {\n        const entityResolution = untrustedResolutions[entityId];\n        if (entityResolution === undefined) {\n            return all;\n        }\n        const resolution = entityResolution[identifier];\n        if (resolution === undefined) {\n            return all;\n        }\n        return { ...all, [identifier]: resolution };\n    }, {});\n    return {\n        ...trustedCompilationData,\n        bytecode: {\n            ...selectedResolutions,\n            ...trustedCompilationData.bytecode,\n        },\n    };\n};\n//# sourceMappingURL=generate-transaction.js.map"],"names":["returnFailedCompilationDirective","index","result","type","error","compileOutputTemplate","outputTemplate","directive","data","compileInputTemplate","inputTemplate","template","outputs","sourceOutputs","generateTransaction","outputResults","outputCompilationErrors","inputResults","inputCompilationErrors"],"mappings":"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","x_google_ignoreList":[0]}
{"version":3,"file":"zv45hi4S.js","sources":["../../../../../../../small/out/index.js"],"sourcesContent":["import template from './template.v3.json' with { type: \"json\" };\nimport packageInfo from '../package.json' with { type: \"json\" };\nimport { createVirtualMachineBch, generateTransaction, hexToBin, verifyTransactionTokens, utf8ToBin, isHex } from '@bitauth/libauth';\nimport { getAddress, getLibauthCompiler, getScriptHash, } from '@unspent/tau';\nexport default class SmallIndex {\n    static USER_AGENT = packageInfo.name;\n    static PROTOCOL_IDENTIFIER = \"U3R\";\n    static VERSION = \"1.0.0\";\n    static tokenAware = true;\n    static template = template;\n    static compiler = getLibauthCompiler(this.template);\n    static vm = createVirtualMachineBch();\n    static parseKey(indexKey) {\n        if (typeof indexKey == \"string\") {\n            if (isHex(indexKey)) {\n                indexKey = hexToBin(indexKey);\n            }\n            else {\n                indexKey = utf8ToBin(indexKey);\n            }\n        }\n        return indexKey;\n    }\n    static getLockingBytecode(indexKey) {\n        const lockingBytecodeResult = this.compiler.generateBytecode({\n            data: {\n                \"bytecode\": {\n                    \"key\": this.parseKey(indexKey)\n                }\n            },\n            scriptId: 'lock'\n        });\n        if (!lockingBytecodeResult.success)\n            throw new Error('Failed to generate bytecode, script: , ' + JSON.stringify(lockingBytecodeResult, null, '  '));\n        return lockingBytecodeResult.bytecode;\n    }\n    /**\n     * Get cashaddress\n     *\n     * @param indexKey - the key for the record.\n     * @param reversed - whether to reverse the hash.\n     * @throws {Error} if transaction generation fails.\n     * @returns a cashaddress.\n     */\n    static getScriptHash(indexKey, reversed = true) {\n        return getScriptHash(this.getLockingBytecode(indexKey), reversed);\n    }\n    /**\n     * Get cashaddress\n     *\n     * @param indexKey - the key for the record.\n     * @param prefix - cashaddress prefix.\n     * @throws {Error} if transaction generation fails.\n     * @returns a cashaddress.\n     */\n    static getAddress(indexKey, prefix = \"bitcoincash\") {\n        return getAddress(this.getLockingBytecode(indexKey), prefix, this.tokenAware);\n    }\n    static getSourceOutput(indexKey, utxo) {\n        return {\n            lockingBytecode: this.getLockingBytecode(indexKey),\n            valueSatoshis: BigInt(utxo.value)\n        };\n    }\n    static getSourceOutputs(indexKey, utxos) {\n        return utxos.map((u) => {\n            return this.getSourceOutput(indexKey, u);\n        });\n    }\n    static getInput(indexKey, utxo) {\n        return {\n            outpointIndex: utxo.tx_pos,\n            outpointTransactionHash: hexToBin(utxo.tx_hash),\n            sequenceNumber: utxo.value,\n            unlockingBytecode: {\n                data: {\n                    \"bytecode\": {\n                        \"key\": this.parseKey(indexKey)\n                    }\n                },\n                compiler: this.compiler,\n                script: 'unlock',\n                valueSatoshis: BigInt(utxo.value),\n            },\n        };\n    }\n    static getInputs(indexKey, utxos) {\n        return utxos.map((u) => {\n            return this.getInput(indexKey, u);\n        });\n    }\n    static getOutput() {\n        return {\n            lockingBytecode: {\n                data: {},\n                compiler: this.compiler,\n                script: 'op_return'\n            },\n            valueSatoshis: BigInt(0)\n        };\n    }\n    /**\n     * Drop expired records.\n     *\n     * @param indexKey - The index key for the record being dropped\n     * @param utxos - List of records to drop.\n     *\n     * @throws {Error} if transaction generation fails.\n     * @returns a transaction template.\n     */\n    static drop(indexKey, utxos) {\n        const inputs = [];\n        const outputs = [];\n        let config = {\n            locktime: 0,\n            version: 2,\n            inputs,\n            outputs\n        };\n        config.inputs.push(...this.getInputs(indexKey, utxos));\n        config.outputs.push(this.getOutput());\n        let result = generateTransaction(config);\n        if (!result.success)\n            throw new Error('generate transaction failed!, errors: ' + JSON.stringify(result.errors, null, '  '));\n        const sourceOutputs = [...this.getSourceOutputs(indexKey, utxos)];\n        const transaction = result.transaction;\n        const tokenValidationResult = verifyTransactionTokens(transaction, sourceOutputs, { maximumTokenCommitmentLength: 40 });\n        if (tokenValidationResult !== true)\n            throw tokenValidationResult;\n        let verify = this.vm.verify({\n            sourceOutputs: sourceOutputs,\n            transaction: transaction,\n        });\n        if (typeof verify == \"string\")\n            throw Error(verify);\n        return {\n            sourceOutputs: sourceOutputs,\n            transaction: transaction,\n            verify: verify\n        };\n    }\n}\n//# sourceMappingURL=index.js.map"],"names":["SmallIndex","packageInfo","template","getLibauthCompiler","createVirtualMachineBch","indexKey","isHex","hexToBin","utf8ToBin","lockingBytecodeResult","reversed","getScriptHash","prefix","getAddress","utxo","utxos","u","config","result","generateTransaction","sourceOutputs","transaction","tokenValidationResult","verifyTransactionTokens","verify"],"mappings":"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"}
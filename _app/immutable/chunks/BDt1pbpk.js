function de(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var q={exports:{}},U,ne;function ve(){if(ne)return U;ne=1;var n=1e3,t=n*60,r=t*60,e=r*24,u=e*7,h=e*365.25;U=function(s,i){i=i||{};var c=typeof s;if(c==="string"&&s.length>0)return C(s);if(c==="number"&&isFinite(s))return i.long?d(s):w(s);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(s))};function C(s){if(s=String(s),!(s.length>100)){var i=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(s);if(i){var c=parseFloat(i[1]),l=(i[2]||"ms").toLowerCase();switch(l){case"years":case"year":case"yrs":case"yr":case"y":return c*h;case"weeks":case"week":case"w":return c*u;case"days":case"day":case"d":return c*e;case"hours":case"hour":case"hrs":case"hr":case"h":return c*r;case"minutes":case"minute":case"mins":case"min":case"m":return c*t;case"seconds":case"second":case"secs":case"sec":case"s":return c*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return c;default:return}}}}function w(s){var i=Math.abs(s);return i>=e?Math.round(s/e)+"d":i>=r?Math.round(s/r)+"h":i>=t?Math.round(s/t)+"m":i>=n?Math.round(s/n)+"s":s+"ms"}function d(s){var i=Math.abs(s);return i>=e?o(s,i,e,"day"):i>=r?o(s,i,r,"hour"):i>=t?o(s,i,t,"minute"):i>=n?o(s,i,n,"second"):s+" ms"}function o(s,i,c,l){var f=i>=c*1.5;return Math.round(s/c)+" "+l+(f?"s":"")}return U}var G,re;function ge(){if(re)return G;re=1;function n(t){e.debug=e,e.default=e,e.coerce=o,e.disable=w,e.enable=h,e.enabled=d,e.humanize=ve(),e.destroy=s,Object.keys(t).forEach(i=>{e[i]=t[i]}),e.names=[],e.skips=[],e.formatters={};function r(i){let c=0;for(let l=0;l<i.length;l++)c=(c<<5)-c+i.charCodeAt(l),c|=0;return e.colors[Math.abs(c)%e.colors.length]}e.selectColor=r;function e(i){let c,l=null,f,g;function a(...b){if(!a.enabled)return;const $=a,m=Number(new Date),A=m-(c||m);$.diff=A,$.prev=c,$.curr=m,c=m,b[0]=e.coerce(b[0]),typeof b[0]!="string"&&b.unshift("%O");let k=0;b[0]=b[0].replace(/%([a-zA-Z%])/g,(T,W)=>{if(T==="%%")return"%";k++;const R=e.formatters[W];if(typeof R=="function"){const B=b[k];T=R.call($,B),b.splice(k,1),k--}return T}),e.formatArgs.call($,b),($.log||e.log).apply($,b)}return a.namespace=i,a.useColors=e.useColors(),a.color=e.selectColor(i),a.extend=u,a.destroy=e.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>l!==null?l:(f!==e.namespaces&&(f=e.namespaces,g=e.enabled(i)),g),set:b=>{l=b}}),typeof e.init=="function"&&e.init(a),a}function u(i,c){const l=e(this.namespace+(typeof c>"u"?":":c)+i);return l.log=this.log,l}function h(i){e.save(i),e.namespaces=i,e.names=[],e.skips=[];const c=(typeof i=="string"?i:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const l of c)l[0]==="-"?e.skips.push(l.slice(1)):e.names.push(l)}function C(i,c){let l=0,f=0,g=-1,a=0;for(;l<i.length;)if(f<c.length&&(c[f]===i[l]||c[f]==="*"))c[f]==="*"?(g=f,a=l,f++):(l++,f++);else if(g!==-1)f=g+1,a++,l=a;else return!1;for(;f<c.length&&c[f]==="*";)f++;return f===c.length}function w(){const i=[...e.names,...e.skips.map(c=>"-"+c)].join(",");return e.enable(""),i}function d(i){for(const c of e.skips)if(C(i,c))return!1;for(const c of e.names)if(C(i,c))return!0;return!1}function o(i){return i instanceof Error?i.stack||i.message:i}function s(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return e.enable(e.load()),e}return G=n,G}var ie;function ye(){return ie||(ie=1,function(n,t){var r={};t.formatArgs=u,t.save=h,t.load=C,t.useColors=e,t.storage=w(),t.destroy=(()=>{let o=!1;return()=>{o||(o=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function e(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let o;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(o=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(o[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function u(o){if(o[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+o[0]+(this.useColors?"%c ":" ")+"+"+n.exports.humanize(this.diff),!this.useColors)return;const s="color: "+this.color;o.splice(1,0,s,"color: inherit");let i=0,c=0;o[0].replace(/%[a-zA-Z%]/g,l=>{l!=="%%"&&(i++,l==="%c"&&(c=i))}),o.splice(c,0,s)}t.log=console.debug||console.log||(()=>{});function h(o){try{o?t.storage.setItem("debug",o):t.storage.removeItem("debug")}catch{}}function C(){let o;try{o=t.storage.getItem("debug")||t.storage.getItem("DEBUG")}catch{}return!o&&typeof process<"u"&&"env"in process&&(o=r.DEBUG),o}function w(){try{return localStorage}catch{}}n.exports=ge()(t);const{formatters:d}=n.exports;d.j=function(o){try{return JSON.stringify(o)}catch(s){return"[UnexpectedJSONParseError]: "+s.message}}}(q,q.exports)),q.exports}var Ee=ye();const D=de(Ee),I={client:D("electrum-cash:client "),errors:D("electrum-cash:error  "),warning:D("electrum-cash:warning"),network:D("electrum-cash:network"),ping:D("electrum-cash:pulses ")};I.client.color="2";I.errors.color="9";I.warning.color="13";I.network.color="4";I.ping.color="8";var E=I,V={exports:{}},se;function $e(){return se||(se=1,function(n){var t=Object.prototype.hasOwnProperty,r="~";function e(){}Object.create&&(e.prototype=Object.create(null),new e().__proto__||(r=!1));function u(d,o,s){this.fn=d,this.context=o,this.once=s||!1}function h(d,o,s,i,c){if(typeof s!="function")throw new TypeError("The listener must be a function");var l=new u(s,i||d,c),f=r?r+o:o;return d._events[f]?d._events[f].fn?d._events[f]=[d._events[f],l]:d._events[f].push(l):(d._events[f]=l,d._eventsCount++),d}function C(d,o){--d._eventsCount===0?d._events=new e:delete d._events[o]}function w(){this._events=new e,this._eventsCount=0}w.prototype.eventNames=function(){var o=[],s,i;if(this._eventsCount===0)return o;for(i in s=this._events)t.call(s,i)&&o.push(r?i.slice(1):i);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(s)):o},w.prototype.listeners=function(o){var s=r?r+o:o,i=this._events[s];if(!i)return[];if(i.fn)return[i.fn];for(var c=0,l=i.length,f=new Array(l);c<l;c++)f[c]=i[c].fn;return f},w.prototype.listenerCount=function(o){var s=r?r+o:o,i=this._events[s];return i?i.fn?1:i.length:0},w.prototype.emit=function(o,s,i,c,l,f){var g=r?r+o:o;if(!this._events[g])return!1;var a=this._events[g],b=arguments.length,$,m;if(a.fn){switch(a.once&&this.removeListener(o,a.fn,void 0,!0),b){case 1:return a.fn.call(a.context),!0;case 2:return a.fn.call(a.context,s),!0;case 3:return a.fn.call(a.context,s,i),!0;case 4:return a.fn.call(a.context,s,i,c),!0;case 5:return a.fn.call(a.context,s,i,c,l),!0;case 6:return a.fn.call(a.context,s,i,c,l,f),!0}for(m=1,$=new Array(b-1);m<b;m++)$[m-1]=arguments[m];a.fn.apply(a.context,$)}else{var A=a.length,k;for(m=0;m<A;m++)switch(a[m].once&&this.removeListener(o,a[m].fn,void 0,!0),b){case 1:a[m].fn.call(a[m].context);break;case 2:a[m].fn.call(a[m].context,s);break;case 3:a[m].fn.call(a[m].context,s,i);break;case 4:a[m].fn.call(a[m].context,s,i,c);break;default:if(!$)for(k=1,$=new Array(b-1);k<b;k++)$[k-1]=arguments[k];a[m].fn.apply(a[m].context,$)}}return!0},w.prototype.on=function(o,s,i){return h(this,o,s,i,!1)},w.prototype.once=function(o,s,i){return h(this,o,s,i,!0)},w.prototype.removeListener=function(o,s,i,c){var l=r?r+o:o;if(!this._events[l])return this;if(!s)return C(this,l),this;var f=this._events[l];if(f.fn)f.fn===s&&(!c||f.once)&&(!i||f.context===i)&&C(this,l);else{for(var g=0,a=[],b=f.length;g<b;g++)(f[g].fn!==s||c&&!f[g].once||i&&f[g].context!==i)&&a.push(f[g]);a.length?this._events[l]=a.length===1?a[0]:a:C(this,l)}return this},w.prototype.removeAllListeners=function(o){var s;return o?(s=r?r+o:o,this._events[s]&&C(this,s)):(this._events=new e,this._eventsCount=0),this},w.prototype.off=w.prototype.removeListener,w.prototype.addListener=w.prototype.on,w.prefixed=r,w.EventEmitter=w,n.exports=w}(V)),V.exports}var ke=$e();const J=de(ke),Se=new Error("request for lock canceled");var Ne=function(n,t,r,e){function u(h){return h instanceof r?h:new r(function(C){C(h)})}return new(r||(r=Promise))(function(h,C){function w(s){try{o(e.next(s))}catch(i){C(i)}}function d(s){try{o(e.throw(s))}catch(i){C(i)}}function o(s){s.done?h(s.value):u(s.value).then(w,d)}o((e=e.apply(n,t||[])).next())})};class _e{constructor(t,r=Se){this._value=t,this._cancelError=r,this._queue=[],this._weightedWaiters=[]}acquire(t=1,r=0){if(t<=0)throw new Error(`invalid weight ${t}: must be positive`);return new Promise((e,u)=>{const h={resolve:e,reject:u,weight:t,priority:r},C=le(this._queue,w=>r<=w.priority);C===-1&&t<=this._value?this._dispatchItem(h):this._queue.splice(C+1,0,h)})}runExclusive(t){return Ne(this,arguments,void 0,function*(r,e=1,u=0){const[h,C]=yield this.acquire(e,u);try{return yield r(h)}finally{C()}})}waitForUnlock(t=1,r=0){if(t<=0)throw new Error(`invalid weight ${t}: must be positive`);return this._couldLockImmediately(t,r)?Promise.resolve():new Promise(e=>{this._weightedWaiters[t-1]||(this._weightedWaiters[t-1]=[]),Fe(this._weightedWaiters[t-1],{resolve:e,priority:r})})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(t){this._value=t,this._dispatchQueue()}release(t=1){if(t<=0)throw new Error(`invalid weight ${t}: must be positive`);this._value+=t,this._dispatchQueue()}cancel(){this._queue.forEach(t=>t.reject(this._cancelError)),this._queue=[]}_dispatchQueue(){for(this._drainUnlockWaiters();this._queue.length>0&&this._queue[0].weight<=this._value;)this._dispatchItem(this._queue.shift()),this._drainUnlockWaiters()}_dispatchItem(t){const r=this._value;this._value-=t.weight,t.resolve([r,this._newReleaser(t.weight)])}_newReleaser(t){let r=!1;return()=>{r||(r=!0,this.release(t))}}_drainUnlockWaiters(){if(this._queue.length===0)for(let t=this._value;t>0;t--){const r=this._weightedWaiters[t-1];r&&(r.forEach(e=>e.resolve()),this._weightedWaiters[t-1]=[])}else{const t=this._queue[0].priority;for(let r=this._value;r>0;r--){const e=this._weightedWaiters[r-1];if(!e)continue;const u=e.findIndex(h=>h.priority<=t);(u===-1?e:e.splice(0,u)).forEach(h=>h.resolve())}}}_couldLockImmediately(t,r){return(this._queue.length===0||this._queue[0].priority<r)&&t<=this._value}}function Fe(n,t){const r=le(n,e=>t.priority<=e.priority);n.splice(r+1,0,t)}function le(n,t){for(let r=n.length-1;r>=0;r--)if(t(n[r]))return r;return-1}var Ie=function(n,t,r,e){function u(h){return h instanceof r?h:new r(function(C){C(h)})}return new(r||(r=Promise))(function(h,C){function w(s){try{o(e.next(s))}catch(i){C(i)}}function d(s){try{o(e.throw(s))}catch(i){C(i)}}function o(s){s.done?h(s.value):u(s.value).then(w,d)}o((e=e.apply(n,t||[])).next())})};class Ae{constructor(t){this._semaphore=new _e(1,t)}acquire(){return Ie(this,arguments,void 0,function*(t=0){const[,r]=yield this._semaphore.acquire(1,t);return r})}runExclusive(t,r=0){return this._semaphore.runExclusive(()=>t(),1,r)}isLocked(){return this._semaphore.isLocked()}waitForUnlock(t=0){return this._semaphore.waitForUnlock(1,t)}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}var F=null;typeof WebSocket<"u"?F=WebSocket:typeof MozWebSocket<"u"?F=MozWebSocket:typeof global<"u"?F=global.WebSocket||global.MozWebSocket:typeof window<"u"?F=window.WebSocket||window.MozWebSocket:typeof self<"u"&&(F=self.WebSocket||self.MozWebSocket);function Te(n,t,r,e){Object.defineProperty(n,t,{get:r,set:e,enumerable:!0,configurable:!0})}var Oe={};Te(Oe,"ElectrumWebSocket",()=>fe);const xe=3e4;class fe extends J{host;port;encrypted;timeout;webSocket;disconnectTimer;onConnectHasRun;eventForwarders;constructor(t,r=50004,e=!0,u=xe){super(),this.host=t,this.port=r,this.encrypted=e,this.timeout=u,this.onConnectHasRun=!1,this.eventForwarders={disconnect:()=>this.emit("disconnected"),wsData:h=>this.emit("data",`${h.data}
`),wsError:h=>this.emit("error",new Error(h.error))}}get hostIdentifier(){return`${this.host}:${this.port}`}connect(){if(this.webSocket)throw new Error("Cannot initiate a new socket connection when an existing connection exists");this.disconnectTimer=setTimeout(()=>this.disconnectOnTimeout(),this.timeout),this.once("connected",this.clearDisconnectTimerOnTimeout);const t=this.encrypted?"an encrypted WebSocket":"a WebSocket";E.network(`Initiating ${t} connection to '${this.host}:${this.port}'.`),this.encrypted?this.webSocket=new F(`wss://${this.host}:${this.port}`):this.webSocket=new F(`ws://${this.host}:${this.port}`),this.webSocket.addEventListener("open",this.onConnect.bind(this)),this.webSocket.addEventListener("error",this.eventForwarders.wsError)}onConnect(){if(this.onConnectHasRun)return;const t=this.encrypted?"an encrypted WebSocket":"a WebSocket";E.network(`Established ${t} connection with '${this.host}:${this.port}'.`),this.webSocket.addEventListener("close",this.eventForwarders.disconnect),this.webSocket.addEventListener("message",this.eventForwarders.wsData),this.onConnectHasRun=!0,this.emit("connected")}clearDisconnectTimerOnTimeout(){this.disconnectTimer&&clearTimeout(this.disconnectTimer)}disconnect(){this.clearDisconnectTimerOnTimeout();try{this.webSocket.removeEventListener("close",this.eventForwarders.disconnect),this.webSocket.removeEventListener("message",this.eventForwarders.wsData),this.webSocket.removeEventListener("error",this.eventForwarders.wsError),this.webSocket.addEventListener("error",t=>{},{once:!0}),this.webSocket.close()}catch{}finally{this.webSocket=void 0}this.onConnectHasRun=!1,this.emit("disconnected")}write(t,r){if(!this.webSocket)throw new Error("Cannot write to socket when there is no active connection");return this.webSocket.send(t,r),!0}disconnectOnTimeout(){this.removeListener("connected",this.clearDisconnectTimerOnTimeout),this.emit("error",new Error(`Connection to '${this.host}:${this.port}' timed out after ${this.timeout} milliseconds`)),this.disconnect()}connected;disconnected;data;error}function Q(n){return De.test(n)}const De=/^-?[0-9]+$/;function Le(n){return Re.test(n)}const Re=/^-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?$/;function qe(n,t){const r=Number.parseFloat(n),e=String(r);if(n===e)return!0;const u=oe(n),h=oe(e);return u===h}let L=function(n){return n.underflow="underflow",n.overflow="overflow",n.truncate_integer="truncate_integer",n.truncate_float="truncate_float",n}({});function Me(n){if(qe(n))return;if(Q(n))return L.truncate_integer;const t=Number.parseFloat(n);return Number.isFinite(t)?t===0?L.underflow:L.truncate_float:L.overflow}function oe(n){let t=0;for(n[0]==="-"&&t++;n[t]==="0"||n[t]===".";)t++;let r=n.lastIndexOf("e");for(r===-1&&(r=n.lastIndexOf("E")),r===-1&&(r=n.length);n[r-1]==="0"||n[r-1]===".";)r--;let e=r>=t?r-t:0;const u=n.indexOf(".",t);return u!==-1&&u<r&&e--,e}class je{isLosslessNumber=!0;constructor(t){if(!Le(t))throw new Error(`Invalid number (value: "${t}")`);this.value=t}valueOf(){const t=Me(this.value);if(t===void 0||t===L.truncate_float)return Number.parseFloat(this.value);if(Q(this.value))return BigInt(this.value);throw new Error(`Cannot safely convert to number: the value '${this.value}' would ${t} and become ${Number.parseFloat(this.value)}`)}toString(){return this.value}}function We(n){return n&&typeof n=="object"&&n.isLosslessNumber||!1}function Be(n){return new je(n)}function Pe(n){return Q(n)?BigInt(n):Number.parseFloat(n)}function Ue(n,t){return Z({"":n},"",n,t)}function Z(n,t,r,e){return Array.isArray(r)?e.call(n,t,Ve(r,e)):r&&typeof r=="object"&&!We(r)?e.call(n,t,Ge(r,e)):e.call(n,t,r)}function Ge(n,t){for(const r of Object.keys(n)){const e=Z(n,r,n[r],t);e!==void 0?n[r]=e:delete n[r]}return n}function Ve(n,t){for(let r=0;r<n.length;r++)n[r]=Z(n,String(r),n[r],t);return n}function He(n,t){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Be,e=0;const u=w();return f(u),a(),t?Ue(u,t):u;function h(){if(n.charCodeAt(e)===Xe){e++,o();const p={};let y=!0;for(;e<n.length&&n.charCodeAt(e)!==ae;){y?y=!1:(c(),o());const N=e,x=s();if(x===void 0){m();return}o(),l();const P=w();if(P===void 0){R();return}Object.prototype.hasOwnProperty.call(p,x)&&!z(P,p[x])&&A(x,N+1),p[x]=P}return n.charCodeAt(e)!==ae&&k(),e++,p}}function C(){if(n.charCodeAt(e)===Ye){e++,o();const p=[];let y=!0;for(;e<n.length&&n.charCodeAt(e)!==ue;){y?y=!1:c();const N=w();g(N),p.push(N)}return n.charCodeAt(e)!==ue&&te(),e++,p}}function w(){o();const p=s()??i()??h()??C()??d("true",!0)??d("false",!1)??d("null",null);return o(),p}function d(p,y){if(n.slice(e,e+p.length)===p)return e+=p.length,y}function o(){for(;Ke(n.charCodeAt(e));)e++}function s(){if(n.charCodeAt(e)===H){e++;let p="";for(;e<n.length&&n.charCodeAt(e)!==H;){if(n.charCodeAt(e)===Ze){const y=n[e+1],N=Qe[y];N!==void 0?(p+=N,e++):y==="u"?M(n.charCodeAt(e+2))&&M(n.charCodeAt(e+3))&&M(n.charCodeAt(e+4))&&M(n.charCodeAt(e+5))?(p+=String.fromCharCode(Number.parseInt(n.slice(e+2,e+6),16)),e+=5):B(e):W(e)}else Je(n.charCodeAt(e))?p+=n[e]:T(n[e]);e++}return $(),e++,p}}function i(){const p=e;if(n.charCodeAt(e)===he&&(e++,b(p)),n.charCodeAt(e)===X)e++;else if(ze(n.charCodeAt(e)))for(e++;j(n.charCodeAt(e));)e++;if(n.charCodeAt(e)===ct)for(e++,b(p);j(n.charCodeAt(e));)e++;if(n.charCodeAt(e)===lt||n.charCodeAt(e)===dt)for(e++,(n.charCodeAt(e)===he||n.charCodeAt(e)===it)&&e++,b(p);j(n.charCodeAt(e));)e++;if(e>p)return r(n.slice(p,e))}function c(){if(n.charCodeAt(e)!==ot)throw new SyntaxError(`Comma ',' expected after value ${S()}`);e++}function l(){if(n.charCodeAt(e)!==at)throw new SyntaxError(`Colon ':' expected after property name ${S()}`);e++}function f(p){if(p===void 0)throw new SyntaxError(`JSON value expected ${S()}`)}function g(p){if(p===void 0)throw new SyntaxError(`Array item expected ${S()}`)}function a(){if(e<n.length)throw new SyntaxError(`Expected end of input ${S()}`)}function b(p){if(!j(n.charCodeAt(e))){const y=n.slice(p,e);throw new SyntaxError(`Invalid number '${y}', expecting a digit ${S()}`)}}function $(){if(n.charCodeAt(e)!==H)throw new SyntaxError(`End of string '"' expected ${S()}`)}function m(){throw new SyntaxError(`Quoted object key expected ${S()}`)}function A(p,y){throw new SyntaxError(`Duplicate key '${p}' encountered at position ${y}`)}function k(){throw new SyntaxError(`Quoted object key or end of object '}' expected ${S()}`)}function te(){throw new SyntaxError(`Array item or end of array ']' expected ${S()}`)}function T(p){throw new SyntaxError(`Invalid character '${p}' ${O()}`)}function W(p){const y=n.slice(p,p+2);throw new SyntaxError(`Invalid escape character '${y}' ${O()}`)}function R(){throw new SyntaxError(`Object value expected after ':' ${O()}`)}function B(p){const y=n.slice(p,p+6);throw new SyntaxError(`Invalid unicode character '${y}' ${O()}`)}function O(){return`at position ${e}`}function be(){return e<n.length?`but got '${n[e]}'`:"but reached end of input"}function S(){return`${be()} ${O()}`}}function Ke(n){return n===et||n===tt||n===nt||n===rt}function M(n){return n>=X&&n<=Y||n>=ut&&n<=ft||n>=ht&&n<=pt}function j(n){return n>=X&&n<=Y}function ze(n){return n>=st&&n<=Y}function Je(n){return n>=32&&n<=1114111}function z(n,t){return n===t?!0:Array.isArray(n)&&Array.isArray(t)?n.length===t.length&&n.every((r,e)=>z(r,t[e])):ce(n)&&ce(t)?[...new Set([...Object.keys(n),...Object.keys(t)])].every(e=>z(n[e],t[e])):!1}function ce(n){return typeof n=="object"&&n!==null}const Qe={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:`
`,r:"\r",t:"	"},Ze=92,Xe=123,ae=125,Ye=91,ue=93,et=32,tt=10,nt=9,rt=13,H=34,it=43,he=45,X=48,st=49,Y=57,ot=44,ct=46,at=58,ut=65,ht=97,dt=69,lt=101,ft=70,pt=102;function ee(n,t,r,e){Object.defineProperty(n,t,{get:r,set:e,enumerable:!0,configurable:!0})}class _{static buildRequestObject(t,r,e){return JSON.stringify({method:t,params:r,id:e})}static get versionRegexp(){return/^\d+(\.\d+)+$/}static get statementDelimiter(){return`
`}}var pe={};ee(pe,"isVersionRejected",()=>we);ee(pe,"isVersionNegotiated",()=>wt);const we=function(n){return"error"in n},wt=function(n){return"software"in n&&"protocol"in n},Ce=function(n){return"id"in n&&"error"in n},me=function(n){return!("id"in n)&&"method"in n};var Ct={};ee(Ct,"ConnectionStatus",()=>v);var v;(function(n){n[n.DISCONNECTED=0]="DISCONNECTED",n[n.CONNECTED=1]="CONNECTED",n[n.DISCONNECTING=2]="DISCONNECTING",n[n.CONNECTING=3]="CONNECTING",n[n.RECONNECTING=4]="RECONNECTING"})(v||(v={}));class mt extends J{constructor(t,r,e,u){if(super(),this.application=t,this.version=r,this.socketOrHostname=e,this.options=u,this.status=v.DISCONNECTED,this.verifications=[],this.messageBuffer="",!_.versionRegexp.test(r))throw new Error(`Provided version string (${r}) is not a valid protocol version number.`);typeof e=="string"?this.socket=new fe(e):this.socket=e,this.socket.on("connected",this.onSocketConnect.bind(this)),this.socket.on("disconnected",this.onSocketDisconnect.bind(this)),this.socket.on("data",this.parseMessageChunk.bind(this)),typeof document<"u"&&document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this)),typeof window<"u"&&(window.addEventListener("online",this.handleNetworkChange.bind(this)),window.addEventListener("offline",this.handleNetworkChange.bind(this)))}get hostIdentifier(){return this.socket.hostIdentifier}get encrypted(){return this.socket.encrypted}parseMessageChunk(t){for(this.lastReceivedTimestamp=Date.now(),this.emit("received"),this.verifications.forEach(r=>clearTimeout(r)),this.verifications.length=0,this.messageBuffer+=t;this.messageBuffer.includes(_.statementDelimiter);){const r=this.messageBuffer.split(_.statementDelimiter);for(;r.length>1;){const e=String(r.shift());let u=He(e,null,this.options.useBigInt?Pe:parseFloat);for(Array.isArray(u)||(u=[u]);u.length>0;){const h=u.shift();if(me(h)){this.emit("response",h);continue}if(h.id==="versionNegotiation"){if(Ce(h))this.emit("version",{error:h.error});else{const[C,w]=h.result;this.emit("version",{software:C,protocol:w})}continue}h.id!=="keepAlive"&&this.emit("response",h)}}this.messageBuffer=r.shift()||""}}ping(){E.ping(`Sending keep-alive ping to '${this.hostIdentifier}'`);const t=_.buildRequestObject("server.ping",[],"keepAlive");return this.send(t)}async connect(){if(this.status===v.CONNECTED)return;this.status=v.CONNECTING,this.emit("connecting");const t=(r,e)=>{const u=C=>{this.status=v.DISCONNECTED,this.emit("disconnected"),e(C)};this.socket.removeAllListeners("error"),this.socket.once("error",u);const h=()=>{E.network(`Requesting protocol version ${this.version} with '${this.hostIdentifier}'.`),this.socket.removeListener("error",u);const C=_.buildRequestObject("server.version",[this.application,this.version],"versionNegotiation"),w=d=>{if(we(d)){this.disconnect(!0);const o="unsupported protocol version.";E.errors(`Failed to connect with ${this.hostIdentifier} due to ${o}`),e(o)}else if(d.protocol!==this.version&&`${d.protocol}.0`!==this.version&&`${d.protocol}.0.0`!==this.version){this.disconnect(!0);const o=`incompatible protocol version negotiated (${d.protocol} !== ${this.version}).`;E.errors(`Failed to connect with ${this.hostIdentifier} due to ${o}`),e(o)}else E.network(`Negotiated protocol version ${d.protocol} with '${this.hostIdentifier}', powered by ${d.software}.`),this.status=v.CONNECTED,this.emit("connected"),r()};this.once("version",w),this.send(C)};this.socket.once("connected",h),this.socket.on("error",this.onSocketError.bind(this)),this.socket.connect()};await new Promise(t)}async reconnect(){await this.clearReconnectTimer(),E.network(`Trying to reconnect to '${this.hostIdentifier}'..`),this.status=v.RECONNECTING,this.emit("reconnecting"),this.socket.disconnect();try{await this.connect()}catch{}}clearReconnectTimer(){this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.reconnectTimer=void 0}clearKeepAliveTimer(){this.keepAliveTimer&&clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0}setupKeepAliveTimer(){this.keepAliveTimer||(this.keepAliveTimer=setTimeout(this.ping.bind(this),this.options.sendKeepAliveIntervalInMilliSeconds))}async disconnect(t=!1,r=!0){if(this.status===v.DISCONNECTED&&!t)return!1;r&&(this.status=v.DISCONNECTING),this.emit("disconnecting"),await this.clearKeepAliveTimer(),await this.clearReconnectTimer();const e=u=>{this.once("disconnected",()=>u(!0)),this.socket.disconnect()};return new Promise(e)}async handleNetworkChange(){typeof window.navigator>"u"||(window.navigator.onLine===!0&&this.reconnect(),window.navigator.onLine!==!0&&this.disconnect(!0,!1))}async handleVisibilityChange(){document.visibilityState==="hidden"&&this.disconnect(!0,!1),document.visibilityState==="visible"&&this.reconnect()}send(t){this.clearKeepAliveTimer();const r=Date.now(),e=setTimeout(this.verifySend.bind(this,r),this.socket.timeout);return this.verifications.push(e),this.setupKeepAliveTimer(),this.socket.write(t+_.statementDelimiter)}verifySend(t){if(Number(this.lastReceivedTimestamp)<t){if(this.status===v.DISCONNECTED||this.status===v.DISCONNECTING)return;this.clearKeepAliveTimer(),E.network(`Connection to '${this.hostIdentifier}' timed out.`),this.socket.disconnect()}}onSocketConnect(){this.clearReconnectTimer(),this.lastReceivedTimestamp=Date.now(),this.setupKeepAliveTimer(),this.socket.removeAllListeners("error"),this.socket.on("error",this.onSocketError.bind(this))}onSocketDisconnect(){this.clearKeepAliveTimer(),this.status===v.DISCONNECTING?(this.status=v.DISCONNECTED,this.emit("disconnected"),this.clearReconnectTimer(),this.removeAllListeners(),E.network(`Disconnected from '${this.hostIdentifier}'.`)):(this.status===v.CONNECTED&&E.errors(`Connection with '${this.hostIdentifier}' was closed, trying to reconnect in ${this.options.reconnectAfterMilliSeconds/1e3} seconds.`),this.status=v.DISCONNECTED,this.emit("disconnected"),this.reconnectTimer||(this.reconnectTimer=setTimeout(this.reconnect.bind(this),this.options.reconnectAfterMilliSeconds)))}onSocketError(t){typeof t>"u"||E.errors(`Network error ('${this.hostIdentifier}'): `,t)}}const K=1e3,bt={useBigInt:!1,sendKeepAliveIntervalInMilliSeconds:1*K,reconnectAfterMilliSeconds:5*K,verifyConnectionTimeoutInMilliSeconds:5*K};class vt extends J{get status(){return this.connection.status}constructor(t,r,e,u={}){super(),this.application=t,this.version=r,this.socketOrHostname=e,this.options=u,this.subscriptionMethods={},this.requestId=0,this.requestResolvers={},this.connectionLock=new Ae;const h={...bt,...u};this.connection=new mt(t,r,e,h)}get hostIdentifier(){return this.connection.hostIdentifier}get encrypted(){return this.connection.encrypted}async connect(){const t=await this.connectionLock.acquire();try{if(this.connection.status===v.CONNECTED)return;this.connection.on("response",this.response.bind(this)),this.connection.on("connected",this.resubscribeOnConnect.bind(this)),this.connection.on("disconnected",this.onConnectionDisconnect.bind(this)),this.connection.on("connecting",this.handleConnectionStatusChanges.bind(this,"connecting")),this.connection.on("disconnecting",this.handleConnectionStatusChanges.bind(this,"disconnecting")),this.connection.on("reconnecting",this.handleConnectionStatusChanges.bind(this,"reconnecting")),this.connection.on("version",this.storeSoftwareVersion.bind(this)),this.connection.on("received",this.updateLastReceivedTimestamp.bind(this)),this.connection.on("error",this.emit.bind(this,"error")),await this.connection.connect()}finally{t()}}async disconnect(t=!1,r=!1){return r||(this.removeAllListeners(),this.subscriptionMethods={}),this.connection.disconnect(t)}async request(t,...r){if(this.connection.status!==v.CONNECTED)throw new Error(`Unable to send request to a disconnected server '${this.hostIdentifier}'.`);this.requestId+=1;const e=this.requestId,u=_.buildRequestObject(t,r,e),h=C=>{this.requestResolvers[e]=(w,d)=>{C(w||d)},this.connection.send(u)};return E.network(`Sending request '${t}' to '${this.hostIdentifier}'`),new Promise(h)}async subscribe(t,...r){this.subscriptionMethods[t]||(this.subscriptionMethods[t]=new Set),this.subscriptionMethods[t].add(JSON.stringify(r));const e=await this.request(t,...r);if(e instanceof Error)throw e;if(Array.isArray(e))throw new Error("Subscription request returned an more than one data point.");const u={jsonrpc:"2.0",method:t,params:[...r,e]};this.emit("notification",u),this.updateChainHeightFromHeadersNotifications(u)}async unsubscribe(t,...r){if(this.connection.status!==v.CONNECTED)throw new Error(`Unable to send unsubscribe request to a disconnected server '${this.hostIdentifier}'.`);if(!this.subscriptionMethods[t])throw new Error(`Cannot unsubscribe from '${t}' since the method has no subscriptions.`);const e=JSON.stringify(r);if(!this.subscriptionMethods[t].has(e))throw new Error(`Cannot unsubscribe from '${t}' since it has no subscription with the given parameters.`);this.subscriptionMethods[t].delete(e),await this.request(t.replace(".subscribe",".unsubscribe"),...r),E.client(`Unsubscribed from '${String(t)}' for the '${e}' parameters.`)}async resubscribeOnConnect(){E.client(`Connected to '${this.hostIdentifier}'.`),this.handleConnectionStatusChanges("connected");const t=[];for(const r in this.subscriptionMethods){for(const e of this.subscriptionMethods[r].values()){const u=JSON.parse(e);t.push(this.subscribe(r,...u))}await Promise.all(t)}t.length>0&&E.client(`Restored ${t.length} previous subscriptions for '${this.hostIdentifier}'`)}response(t){if(me(t)){E.client(`Received notification for '${t.method}' from '${this.hostIdentifier}'`),this.emit("notification",t),this.updateChainHeightFromHeadersNotifications(t);return}if(t.id===null)throw new Error("Internal error: Received an RPC response with ID null.");const r=this.requestResolvers[t.id];if(!r){E.warning(`Ignoring response #${t.id} as the request has already been rejected.`);return}delete this.requestResolvers[t.id],Ce(t)?r(new Error(t.error.message)):(r(void 0,t.result),this.storeGenesisHashFromFeaturesResponse(t))}async onConnectionDisconnect(){for(const t in this.requestResolvers){const r=this.requestResolvers[t];r(new Error("Connection lost")),delete this.requestResolvers[t]}this.handleConnectionStatusChanges("disconnected")}async storeSoftwareVersion(t){t.error||(this.software=t.software)}async updateLastReceivedTimestamp(){this.lastReceivedTimestamp=Date.now()}async updateChainHeightFromHeadersNotifications(t){t.method==="blockchain.headers.subscribe"&&(this.chainHeight=t.params[0].height)}async storeGenesisHashFromFeaturesResponse(t){try{typeof t.result.genesis_hash<"u"&&(this.genesisHash=t.result.genesis_hash)}catch{}}async handleConnectionStatusChanges(t){this.emit(t)}}var gt=vt;export{gt as $,Ae as M,v as a,J as b,E as c,fe as d,Pe as e,He as p};
//# sourceMappingURL=BDt1pbpk.js.map
